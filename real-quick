#!/usr/bin/env bash

export PATH="$PATH:/usr/local/bin:/usr/bin:/bin"
# Detect script directory (resolve symlinks) - portable version
if [ -n "${BASH_SOURCE:-}" ]; then
  SOURCE="${BASH_SOURCE[0]}"
else
  SOURCE="$0"
fi

# Resolve symlinks
while [ -L "$SOURCE" ]; do
  SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  case "$SOURCE" in
    /*) ;;
    *) SOURCE="$SCRIPT_DIR/$SOURCE" ;;
  esac
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
DPATH="${REALQUICK_HOME:-$SCRIPT_DIR}"
JSON_FILE="$DPATH/functions.json"
if [ -z "$1" ]; then
  selected_item=$(jq -r 'keys[]' "$JSON_FILE" | rofi -dmenu -i -p "RealQuick:")
else
  selected_item="$1"
fi

if [ -n "$selected_item" ]; then
  IFS='
'
  commands=$(jq -r ".\"$selected_item\"[]" "$JSON_FILE")
  last_output=""
  for cmd in $commands; do
    case "$cmd" in
      *"sh process-snippet"*)
        cmd="$cmd \"$last_output\""
        ;;
    esac
    cmd="cd $DPATH && $cmd"
    last_output=$(eval "$cmd")
  done
fi
